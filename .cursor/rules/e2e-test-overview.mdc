---
description: Overview of BDD stage-based e2e testing - core concepts and navigation hub
globs: tests/**/*_test.go
alwaysApply: true
---

# E2E Test Overview

This guide provides an overview of the **Given-When-Then** BDD pattern with stage-based architecture for e2e testing.

## Core Concepts

The stage-based BDD pattern separates test concerns into three clear phases:

1. **Given** (Setup): Prepare test data and initial state
2. **When** (Action): Execute the operation being tested
3. **Then** (Assertion): Verify the outcome

Each feature test is composed of 2-3 files:

```
tests/
├── <feature>_test.go          # Test cases (required)
├── <feature>_test_stage.go    # Stage struct and methods (required)
└── <feature>_test_opts.go     # Functional options for variations (optional)
```

## Quick Start Checklist

Before creating a new e2e test, answer these questions:

- [ ] What endpoint/feature am I testing? (e.g., `POST /api/v1/resource`)
- [ ] What is the primary action? (e.g., `create_resource`, `update_resource`)
- [ ] Do I need to verify published events/messages?
- [ ] Will I test multiple variations? (determines if opts file is needed)
- [ ] What external dependencies do I need? (database, message broker, cache)

## Method Naming Quick Reference

| Phase | Prefix Examples | Purpose |
|-------|----------------|---------|
| Given | `a...`, `an...`, `the...` | Setup test state |
| When | `create...`, `update...`, `the...IsCalled()` | Execute action |
| Then | `...Should...`, `...IsReceived()` | Verify outcome |

## When to Use This Pattern

**Best for:**
- API/HTTP endpoint testing
- Integration tests with external dependencies
- Event-driven architecture testing
- Multi-step workflow testing
- Tests requiring complex setup

**Not ideal for:**
- Simple unit tests (overkill)
- Tests with minimal setup (unnecessary overhead)

## Navigation Guide

For detailed information, see:

- **e2e-testing-standards.mdc** - Complete reference for all BDD testing rules and patterns
- **e2e-test-stage-methods.mdc** - Detailed Given/When/Then method implementation patterns
- **e2e-test-setup-patterns.mdc** - Setup configurations for various architectures (DB, NATS, Kafka, etc.)
- **e2e-test-examples.mdc** - Complete practical examples and code templates

## Common Questions

**Q: Should I create a new stage file for each endpoint?**
A: Generally yes, but related endpoints can share stages (e.g., CRUD operations on same resource). See **e2e-testing-standards.mdc** for file organization rules.

**Q: How do I handle test data that needs to persist across multiple tests?**
A: Use `TestMain` for global setup, or use `t.Run` subtests with shared setup. See **e2e-test-examples.mdc** for examples.

**Q: Can I use this pattern for unit tests?**
A: It's overkill for most unit tests. This pattern shines for integration/e2e tests.

**Q: How do I test error scenarios?**
A: Use functional options to create invalid requests and verify error responses. See **e2e-test-stage-methods.mdc** for functional options pattern.

**Q: How do I set up NATS/Kafka/RabbitMQ for event testing?**
A: See **e2e-test-setup-patterns.mdc** for complete setup examples for all major message brokers.

**Q: Where can I find complete test examples?**
A: See **e2e-test-examples.mdc** for 7 practical examples including POST, GET, PATCH, DELETE, auth, and event-driven tests.

## Best Practices Checklist

### Test Structure
- [ ] Test function names start with `Test` (e.g., `TestCreateResource`)
- [ ] Test case names start with "when" and describe the scenario
- [ ] Each test creates fresh stage instance (`given, when, then := newStage(t)`)
- [ ] No logic in test functions - delegate to stage methods
- [ ] Tests are independent and can run in any order

### Stage Methods
- [ ] All stage methods return `*stage` for chaining
- [ ] Given methods use functional options for flexibility
- [ ] When methods only execute actions (no validation)
- [ ] Then methods perform assertions and validation

### Configuration & Data
- [ ] All connection strings use environment variables with defaults
- [ ] Unique values generated for unique fields (emails, IDs, etc.)
- [ ] `t.Cleanup()` is used for all resource cleanup

### Assertions
- [ ] `require` used for critical operations (parsing, network calls)
- [ ] `assert` used for value comparisons
- [ ] Both success and error scenarios tested

---

**Remember**: Good tests are readable, maintainable, and reliable. For detailed implementation patterns, consult **e2e-testing-standards.mdc**.
